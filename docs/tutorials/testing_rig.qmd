---
title: "Notebook for testing - still in draft stage"
execute:
  warning: False
format:
  html:
    code-fold: true
jupyter: python3
---

```{python}
#| code-summary: Import modules
from classifai.testing_rig_functions import *
```

```{python}
#| code-summary: Read in the test data

'''
Ensure that you have executed `python src/classifai/soc_index.py` previously.

Test are based on the first 4 digits of the code i.e. if the LLM provides a
6-digit SOC code which is incorrect but the first 4 digits are correct then
this is considered a true positive.
'''

input_data_filepath = 'data/example_survey_data.csv'
input_data = read_csv_to_dict_list(file_path=input_data_filepath)
```

```{python}
#| code-summary: Set up the test parameters

tests = [
  {
    "test_name": "test_1",
    "classification_type": "soc",
    "number_of_digit_classification": 4,
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2",
    "number_of_retrievals": 20,
    "load_existing_index": False,
    "embedding_index_file": "soc_6_digit.csv",
    "embedding_columns_index": ["group_title"],
    "label_column_index": "soc_code",
    "distance_metric": "l2",
    "llm": "gemini-1.0-pro",
    "id_column_dataset": "id",
    "embedding_columns_dataset": ["job_title", "company"],
    "label_column_dataset": "soc_code"
  },
  {
    "test_name": "test_2",
    "classification_type": "soc",
    "number_of_digit_classification": 4,
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2",
    "number_of_retrievals": 20,
    "load_existing_index": False,
    "embedding_index_file": "soc_6_digit.csv",
    "embedding_columns_index": ["descriptions_job"],
    "label_column_index": "soc_code",
    "distance_metric": "l2",
    "llm": "gemini-1.0-pro",
    "id_column_dataset": "id",
    "embedding_columns_dataset": ["job_title", "company"],
    "label_column_dataset": "soc_code"
  },
  {
    "test_name": "test_3",
    "classification_type": "soc",
    "number_of_digit_classification": 4,
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2",
    "number_of_retrievals": 20,
    "load_existing_index": False,
    "embedding_index_file": "soc_6_digit.csv",
    "embedding_columns_index": ["group_title", "descriptions_education"],
    "label_column_index": "soc_code",
    "distance_metric": "l2",
    "llm": "gemini-1.0-pro",
    "id_column_dataset": "id",
    "embedding_columns_dataset": ["job_title", "company"],
    "label_column_dataset": "soc_code"
  },
  {
    "test_name": "test_4",
    "classification_type": "soc",
    "number_of_digit_classification": 4,
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2",
    "number_of_retrievals": 20,
    "load_existing_index": False,
    "embedding_index_file": "soc_6_digit.csv",
    "embedding_columns_index": ["descriptions_job", "descriptions_education"],
    "label_column_index": "soc_code",
    "distance_metric": "l2",
    "llm": "gemini-1.0-pro",
    "id_column_dataset": "id",
    "embedding_columns_dataset": ["job_title", "company"],
    "label_column_dataset": "soc_code"
  },
  {
    "test_name": "test_5",
    "classification_type": "soc",
    "number_of_digit_classification": 4,
    "embedding_model": "sentence-transformers/all-MiniLM-L6-v2",
    "number_of_retrievals": 20,
    "load_existing_index": False,
    "embedding_index_file": "soc_4_digit.csv",
    "embedding_columns_index": ["unit_group"],
    "label_column_index": "soc_code",
    "distance_metric": "l2",
    "llm": "gemini-1.0-pro",
    "id_column_dataset": "id",
    "embedding_columns_dataset": ["job_title", "company"],
    "label_column_dataset": "soc_code"
  },
]
```

```{python}
#| code-summary: Run each test

for test in tests:

  result_table = create_result_table(test_parameters=test, input_data_filepath=input_data_filepath)

  # Create a folder to save the results
  folder_name = create_output_folder(test_parameters=test)

  # Embed the index
  embed = create_embedding_index(test_parameters=test)

  # Get the retrieval results
  result, processed_result = search_embedding_index(test_parameters=test, input_data=input_data, embed=embed, folder_name=folder_name)

  # Add the retrieval results to table
  result_table = add_retrieval_results_to_table(test_parameters=test, result_table=result_table, processed_result=processed_result)

  # Set up the LLM and candidates
  rag_candidates, classifier = set_up_llm(test_parameters=test, embed=embed, result=result)

  # Return the results of the LLM
  llm_result_dict = get_llm_results(test_parameters=test, input_data=input_data, rag_candidates=rag_candidates, classifier=classifier, folder_name=folder_name)

  # Add LLM results to table
  result_table = add_llm_results_to_table(test_parameters=test, result_table=result_table, llm_result_dict=llm_result_dict, folder_name=folder_name)

  # Create accuracy summary table
  create_accuracy_summary_table(test_parameters=test, result_table=result_table, folder_name=folder_name)
```
