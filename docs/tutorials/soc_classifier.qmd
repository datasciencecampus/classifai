---
title: "SOC classifier"
execute:
  warning: False
format:
  html:
    code-fold: true
jupyter: python3
---

Demonstration notebook for SOC classification.

```{python}
#| code-summary: "Code: Import methods and initialise"
from classifai.embedding import EmbeddingHandler
from classifai.api import API
from classifai.doc_utils import print_processed_output

# use default Hugging Face model
embed = EmbeddingHandler(
    k_matches=10,
    #embedding_model_name="models/text-embedding-004"
)
```

## Embed the index

If you have a SOC index already embedded you can skip this step.

```{python}
#| code-summary: "Code: Embed the master index to 4-digits."
embed.embed_index(file_name="data/soc-index/soc_title_condensed.txt")
```

```{python}
#| code-summary: "Code: Embed the 6-digit index. This will take about 10 minutes for `text-embedding-004`."
import os

#os.system("python src/classifai/soc_index.py")

#embed.embed_index_csv(file="data/soc-index/soc_6_digit.csv", label_column="soc_code", embedding_columns=["group_title"])
```

## Input the query data

```{python}
#| code-summary: "Code: Query the index"

embedded_fields=["job_title"]

input_data = [
    {
        "id": "1",
        "job_title": "Fishing Trawler Captain",
        "company": "Grimsby Fishing Fleet",
    },
    {
        "id": "2",
        "job_title": "Anaesthetist",
        "company": "London General Hospital",
    },
    {
        "id": "3",
        "job_title": "Operational Researcher",
        "company": "Department for Environment, Food and Rural Affairs",
    },
    {
        "id": "4",
        "job_title": "HEO",
        "company": "Home Office",

    }
]

result = embed.search_index(
    input_data=input_data,
    embedded_fields=embedded_fields,
)
```

## Print the result from the embedding search

```{python}
#| code-summary: "Process the output of the embedding search"
processed_result = API.simplify_output(output_data=result,
                                       input_data=input_data,
                                       id_field="id")

print_processed_output(processed_result,
                       input_data,
                       embedded_fields=embedded_fields)
```

## Use LLM to determine the most appropriate result

```{python}
#| code-summary: "Set up the LLM"
from classifai.llm import ClassificationLLM

rag_candidates = embed.process_result_for_rag(result)
classifier = ClassificationLLM(model_name="gemini-pro")
```

```{python}
#| code-summary: "Return the results of the LLM"
for input_document, search_result in zip(input_data, rag_candidates):
    llm_result = classifier.get_soc_code(
        input_document["job_title"],
        None,
        input_document["company"],
        search_result,
    )
    print(llm_result)
```
