name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate-changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Validate changelog contains version
        run: |
          set -e
          VERSION="${{ inputs.version }}"
          PATTERN="^## \[(v)?${VERSION}\]"
          echo "Checking CHANGELOG.md for header: $PATTERN"
          MATCH_COUNT=$(grep -c -E "$PATTERN" CHANGELOG.md || true)
          if [ "$MATCH_COUNT" -eq 0 ]; then
            echo "ERROR: No changelog section found for v$VERSION" >&2
            exit 1
          fi
          if [ "$MATCH_COUNT" -gt 1 ]; then
            echo "ERROR: Multiple changelog sections found for v$VERSION" >&2
            exit 1
          fi
          echo "Changelog validation passed."

  extract-changelog:
    runs-on: ubuntu-latest
    needs: validate-changelog
    outputs:
      notes_artifact: release_notes
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Extract changelog section
        run: |
          set -e
          VERSION="${{ inputs.version }}"
          HEADER_PATTERN="^## \[(v)?${VERSION}\]"
          echo "Extracting section starting with: $HEADER_PATTERN"
          awk -v header="$HEADER_PATTERN" 'BEGIN{found=0}
            $0 ~ header { if(found){ exit 1 } found=1 }
            found {
              if($0 ~ /^## \[/ && $0 !~ header){ exit }
              print $0
            }
          ' CHANGELOG.md > raw_release_notes.md || {
            echo "Failed to extract changelog section" >&2; exit 1; }
          # Trim trailing blank lines
          awk 'NF{p=1} p' raw_release_notes.md > release_notes.md
          echo "Extracted release notes:"; cat release_notes.md
      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_notes
          path: release_notes.md

  release:
    runs-on: ubuntu-latest
    needs: extract-changelog
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version with uv
        run: |
          uv version ${{ inputs.version }}

      - name: Commit version bump
        run: |
          git add pyproject.toml
          git commit -m "Bump version to ${{ inputs.version }}"
          git push

      - name: Download extracted release notes
        uses: actions/download-artifact@v4
        with:
          name: release_notes
          path: release_notes

      - name: Create and push tag
        run: |
          git tag "v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "Release ${{ inputs.version }}" \
            --notes-file release_notes/release_notes.md

  add-wheel:
    runs-on: ubuntu-latest
    needs: release
    environment: release
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Build
        run: |
          uv build
      - name: Upload wheel to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="v${{ inputs.version }}"
          for wheel in dist/*.whl; do
            gh release upload "$RELEASE_TAG" "$wheel" --clobber
          done
